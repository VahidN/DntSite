/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/quill@2.0.3/modules/syntax.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import Delta from"quill-delta";import{ClassAttributor,Scope}from"parchment";import Inline from"../blots/inline.js";import Quill from"../core/quill.js";import Module from"../core/module.js";import{blockDelta}from"../blots/block.js";import BreakBlot from"../blots/break.js";import CursorBlot from"../blots/cursor.js";import TextBlot,{escapeText}from"../blots/text.js";import CodeBlock,{CodeBlockContainer}from"../formats/code.js";import{traverse}from"./clipboard.js";const TokenAttributor=new ClassAttributor("code-token","hljs",{scope:Scope.INLINE});class CodeToken extends Inline{static formats(e,t){for(;null!=e&&e!==t.domNode;){if(e.classList&&e.classList.contains(CodeBlock.className))return super.formats(e,t);e=e.parentNode}}constructor(e,t,o){super(e,t,o),TokenAttributor.add(this.domNode,o)}format(e,t){e!==CodeToken.blotName?super.format(e,t):t?TokenAttributor.add(this.domNode,t):(TokenAttributor.remove(this.domNode),this.domNode.classList.remove(this.statics.className))}optimize(){super.optimize(...arguments),TokenAttributor.value(this.domNode)||this.unwrap()}}CodeToken.blotName="code-token",CodeToken.className="ql-token";class SyntaxCodeBlock extends CodeBlock{static create(e){const t=super.create(e);return"string"==typeof e&&t.setAttribute("data-language",e),t}static formats(e){return e.getAttribute("data-language")||"plain"}static register(){}format(e,t){e===this.statics.blotName&&t?this.domNode.setAttribute("data-language",t):super.format(e,t)}replaceWith(e,t){return this.formatAt(0,this.length(),CodeToken.blotName,!1),super.replaceWith(e,t)}}class SyntaxCodeBlockContainer extends CodeBlockContainer{attach(){super.attach(),this.forceNext=!1,this.scroll.emitMount(this)}format(e,t){e===SyntaxCodeBlock.blotName&&(this.forceNext=!0,this.children.forEach((o=>{o.format(e,t)})))}formatAt(e,t,o,l){o===SyntaxCodeBlock.blotName&&(this.forceNext=!0),super.formatAt(e,t,o,l)}highlight(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==this.children.head)return;const o=`${Array.from(this.domNode.childNodes).filter((e=>e!==this.uiNode)).map((e=>e.textContent)).join("\n")}\n`,l=SyntaxCodeBlock.formats(this.children.head.domNode);if(t||this.forceNext||this.cachedText!==o){if(o.trim().length>0||null==this.cachedText){const t=this.children.reduce(((e,t)=>e.concat(blockDelta(t,!1))),new Delta),i=e(o,l);t.diff(i).reduce(((e,t)=>{let{retain:o,attributes:l}=t;return o?(l&&Object.keys(l).forEach((t=>{[SyntaxCodeBlock.blotName,CodeToken.blotName].includes(t)&&this.formatAt(e,o,t,l[t])})),e+o):e}),0)}this.cachedText=o,this.forceNext=!1}}html(e,t){const[o]=this.children.find(e);return`<pre data-language="${o?SyntaxCodeBlock.formats(o.domNode):"plain"}">\n${escapeText(this.code(e,t))}\n</pre>`}optimize(e){if(super.optimize(e),null!=this.parent&&null!=this.children.head&&null!=this.uiNode){const e=SyntaxCodeBlock.formats(this.children.head.domNode);e!==this.uiNode.value&&(this.uiNode.value=e)}}}SyntaxCodeBlockContainer.allowedChildren=[SyntaxCodeBlock],SyntaxCodeBlock.requiredContainer=SyntaxCodeBlockContainer,SyntaxCodeBlock.allowedChildren=[CodeToken,CursorBlot,TextBlot,BreakBlot];const highlight=(e,t,o)=>{if("string"==typeof e.versionString){const l=e.versionString.split(".")[0];if(parseInt(l,10)>=11)return e.highlight(o,{language:t}).value}return e.highlight(t,o).value};class Syntax extends Module{static register(){Quill.register(CodeToken,!0),Quill.register(SyntaxCodeBlock,!0),Quill.register(SyntaxCodeBlockContainer,!0)}constructor(e,t){if(super(e,t),null==this.options.hljs)throw new Error("Syntax module requires highlight.js. Please include the library on the page before Quill.");this.languages=this.options.languages.reduce(((e,t)=>{let{key:o}=t;return e[o]=!0,e}),{}),this.highlightBlot=this.highlightBlot.bind(this),this.initListener(),this.initTimer()}initListener(){this.quill.on(Quill.events.SCROLL_BLOT_MOUNT,(e=>{if(!(e instanceof SyntaxCodeBlockContainer))return;const t=this.quill.root.ownerDocument.createElement("select");this.options.languages.forEach((e=>{let{key:o,label:l}=e;const i=t.ownerDocument.createElement("option");i.textContent=l,i.setAttribute("value",o),t.appendChild(i)})),t.addEventListener("change",(()=>{e.format(SyntaxCodeBlock.blotName,t.value),this.quill.root.focus(),this.highlight(e,!0)})),null==e.uiNode&&(e.attachUI(t),e.children.head&&(t.value=SyntaxCodeBlock.formats(e.children.head.domNode)))}))}initTimer(){let e=null;this.quill.on(Quill.events.SCROLL_OPTIMIZE,(()=>{e&&clearTimeout(e),e=setTimeout((()=>{this.highlight(),e=null}),this.options.interval)}))}highlight(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.quill.selection.composing)return;this.quill.update(Quill.sources.USER);const o=this.quill.getSelection();(null==e?this.quill.scroll.descendants(SyntaxCodeBlockContainer):[e]).forEach((e=>{e.highlight(this.highlightBlot,t)})),this.quill.update(Quill.sources.SILENT),null!=o&&this.quill.setSelection(o,Quill.sources.SILENT)}highlightBlot(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"plain";if(t=this.languages[t]?t:"plain","plain"===t)return escapeText(e).split("\n").reduce(((e,o,l)=>(0!==l&&e.insert("\n",{[CodeBlock.blotName]:t}),e.insert(o))),new Delta);const o=this.quill.root.ownerDocument.createElement("div");return o.classList.add(CodeBlock.className),o.innerHTML=highlight(this.options.hljs,t,e),traverse(this.quill.scroll,o,[(e,t)=>{const o=TokenAttributor.value(e);return o?t.compose((new Delta).retain(t.length(),{[CodeToken.blotName]:o})):t}],[(e,o)=>e.data.split("\n").reduce(((e,o,l)=>(0!==l&&e.insert("\n",{[CodeBlock.blotName]:t}),e.insert(o))),o)],new WeakMap)}}Syntax.DEFAULTS={hljs:window.hljs,interval:1e3,languages:[{key:"plain",label:"Plain"},{key:"bash",label:"Bash"},{key:"cpp",label:"C++"},{key:"cs",label:"C#"},{key:"css",label:"CSS"},{key:"diff",label:"Diff"},{key:"xml",label:"HTML/XML"},{key:"java",label:"Java"},{key:"javascript",label:"JavaScript"},{key:"markdown",label:"Markdown"},{key:"php",label:"PHP"},{key:"python",label:"Python"},{key:"ruby",label:"Ruby"},{key:"sql",label:"SQL"}]};export{SyntaxCodeBlock as CodeBlock,CodeToken,Syntax as default};
//# sourceMappingURL=/sm/7f52fbb655013dd0724a386ec96358d543db4fd36d0f11b771e3fa42e0b5c551.map