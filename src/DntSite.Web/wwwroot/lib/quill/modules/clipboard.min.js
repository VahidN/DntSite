/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/quill@2.0.3/modules/clipboard.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Attributor,BlockBlot,ClassAttributor,EmbedBlot,Scope,StyleAttributor}from"parchment";import Delta from"quill-delta";import{BlockEmbed}from"../blots/block.js";import logger from"../core/logger.js";import Module from"../core/module.js";import Quill from"../core/quill.js";import{AlignAttribute,AlignStyle}from"../formats/align.js";import{BackgroundStyle}from"../formats/background.js";import CodeBlock from"../formats/code.js";import{ColorStyle}from"../formats/color.js";import{DirectionAttribute,DirectionStyle}from"../formats/direction.js";import{FontStyle}from"../formats/font.js";import{SizeStyle}from"../formats/size.js";import{deleteRange}from"./keyboard.js";import normalizeExternalHTML from"./normalizeExternalHTML/index.js";const debug=logger("quill:clipboard"),CLIPBOARD_CONFIG=[[Node.TEXT_NODE,matchText],[Node.TEXT_NODE,matchNewline],["br",matchBreak],[Node.ELEMENT_NODE,matchNewline],[Node.ELEMENT_NODE,matchBlot],[Node.ELEMENT_NODE,matchAttributor],[Node.ELEMENT_NODE,matchStyles],["li",matchIndent],["ol, ul",matchList],["pre",matchCodeBlock],["tr",matchTable],["b",createMatchAlias("bold")],["i",createMatchAlias("italic")],["strike",createMatchAlias("strike")],["style",matchIgnore]],ATTRIBUTE_ATTRIBUTORS=[AlignAttribute,DirectionAttribute].reduce(((t,e)=>(t[e.keyName]=e,t)),{}),STYLE_ATTRIBUTORS=[AlignStyle,BackgroundStyle,ColorStyle,DirectionStyle,FontStyle,SizeStyle].reduce(((t,e)=>(t[e.keyName]=e,t)),{});class Clipboard extends Module{static DEFAULTS={matchers:[]};constructor(t,e){super(t,e),this.quill.root.addEventListener("copy",(t=>this.onCaptureCopy(t,!1))),this.quill.root.addEventListener("cut",(t=>this.onCaptureCopy(t,!0))),this.quill.root.addEventListener("paste",this.onCapturePaste.bind(this)),this.matchers=[],CLIPBOARD_CONFIG.concat(this.options.matchers??[]).forEach((t=>{let[e,n]=t;this.addMatcher(e,n)}))}addMatcher(t,e){this.matchers.push([t,e])}convert(t){let{html:e,text:n}=t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(r[CodeBlock.blotName])return(new Delta).insert(n||"",{[CodeBlock.blotName]:r[CodeBlock.blotName]});if(!e)return(new Delta).insert(n||"",r);const l=this.convertHTML(e);return deltaEndsWith(l,"\n")&&(null==l.ops[l.ops.length-1].attributes||r.table)?l.compose((new Delta).retain(l.length()-1).delete(1)):l}normalizeHTML(t){normalizeExternalHTML(t)}convertHTML(t){const e=(new DOMParser).parseFromString(t,"text/html");this.normalizeHTML(e);const n=e.body,r=new WeakMap,[l,i]=this.prepareMatching(n,r);return traverse(this.quill.scroll,n,l,i,r)}dangerouslyPasteHTML(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Quill.sources.API;if("string"==typeof t){const n=this.convert({html:t,text:""});this.quill.setContents(n,e),this.quill.setSelection(0,Quill.sources.SILENT)}else{const r=this.convert({html:e,text:""});this.quill.updateContents((new Delta).retain(t).concat(r),n),this.quill.setSelection(t+r.length(),Quill.sources.SILENT)}}onCaptureCopy(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t.defaultPrevented)return;t.preventDefault();const[n]=this.quill.selection.getRange();if(null==n)return;const{html:r,text:l}=this.onCopy(n,e);t.clipboardData?.setData("text/plain",l),t.clipboardData?.setData("text/html",r),e&&deleteRange({range:n,quill:this.quill})}normalizeURIList(t){return t.split(/\r?\n/).filter((t=>"#"!==t[0])).join("\n")}onCapturePaste(t){if(t.defaultPrevented||!this.quill.isEnabled())return;t.preventDefault();const e=this.quill.getSelection(!0);if(null==e)return;const n=t.clipboardData?.getData("text/html");let r=t.clipboardData?.getData("text/plain");if(!n&&!r){const e=t.clipboardData?.getData("text/uri-list");e&&(r=this.normalizeURIList(e))}const l=Array.from(t.clipboardData?.files||[]);if(!n&&l.length>0)this.quill.uploader.upload(e,l);else{if(n&&l.length>0){const t=(new DOMParser).parseFromString(n,"text/html");if(1===t.body.childElementCount&&"IMG"===t.body.firstElementChild?.tagName)return void this.quill.uploader.upload(e,l)}this.onPaste(e,{html:n,text:r})}}onCopy(t){const e=this.quill.getText(t);return{html:this.quill.getSemanticHTML(t),text:e}}onPaste(t,e){let{text:n,html:r}=e;const l=this.quill.getFormat(t.index),i=this.convert({text:n,html:r},l);debug.log("onPaste",i,{text:n,html:r});const o=(new Delta).retain(t.index).delete(t.length).concat(i);this.quill.updateContents(o,Quill.sources.USER),this.quill.setSelection(o.length()-t.length,Quill.sources.SILENT),this.quill.scrollSelectionIntoView()}prepareMatching(t,e){const n=[],r=[];return this.matchers.forEach((l=>{const[i,o]=l;switch(i){case Node.TEXT_NODE:r.push(o);break;case Node.ELEMENT_NODE:n.push(o);break;default:Array.from(t.querySelectorAll(i)).forEach((t=>{if(e.has(t)){const n=e.get(t);n?.push(o)}else e.set(t,[o])}))}})),[n,r]}}function applyFormat(t,e,n,r){return r.query(e)?t.reduce(((t,r)=>{if(!r.insert)return t;if(r.attributes&&r.attributes[e])return t.push(r);const l=n?{[e]:n}:{};return t.insert(r.insert,{...l,...r.attributes})}),new Delta):t}function deltaEndsWith(t,e){let n="";for(let r=t.ops.length-1;r>=0&&n.length<e.length;--r){const e=t.ops[r];if("string"!=typeof e.insert)break;n=e.insert+n}return n.slice(-1*e.length)===e}function isLine(t,e){if(!(t instanceof Element))return!1;const n=e.query(t);return!(n&&n.prototype instanceof EmbedBlot)&&["address","article","blockquote","canvas","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","iframe","li","main","nav","ol","output","p","pre","section","table","td","tr","ul","video"].includes(t.tagName.toLowerCase())}function isBetweenInlineElements(t,e){return t.previousElementSibling&&t.nextElementSibling&&!isLine(t.previousElementSibling,e)&&!isLine(t.nextElementSibling,e)}const preNodes=new WeakMap;function isPre(t){return null!=t&&(preNodes.has(t)||("PRE"===t.tagName?preNodes.set(t,!0):preNodes.set(t,isPre(t.parentNode))),preNodes.get(t))}function traverse(t,e,n,r,l){return e.nodeType===e.TEXT_NODE?r.reduce(((n,r)=>r(e,n,t)),new Delta):e.nodeType===e.ELEMENT_NODE?Array.from(e.childNodes||[]).reduce(((i,o)=>{let a=traverse(t,o,n,r,l);return o.nodeType===e.ELEMENT_NODE&&(a=n.reduce(((e,n)=>n(o,e,t)),a),a=(l.get(o)||[]).reduce(((e,n)=>n(o,e,t)),a)),i.concat(a)}),new Delta):new Delta}function createMatchAlias(t){return(e,n,r)=>applyFormat(n,t,!0,r)}function matchAttributor(t,e,n){const r=Attributor.keys(t),l=ClassAttributor.keys(t),i=StyleAttributor.keys(t),o={};return r.concat(l).concat(i).forEach((e=>{let r=n.query(e,Scope.ATTRIBUTE);null!=r&&(o[r.attrName]=r.value(t),o[r.attrName])||(r=ATTRIBUTE_ATTRIBUTORS[e],null==r||r.attrName!==e&&r.keyName!==e||(o[r.attrName]=r.value(t)||void 0),r=STYLE_ATTRIBUTORS[e],null==r||r.attrName!==e&&r.keyName!==e||(r=STYLE_ATTRIBUTORS[e],o[r.attrName]=r.value(t)||void 0))})),Object.entries(o).reduce(((t,e)=>{let[r,l]=e;return applyFormat(t,r,l,n)}),e)}function matchBlot(t,e,n){const r=n.query(t);if(null==r)return e;if(r.prototype instanceof EmbedBlot){const e={},l=r.value(t);if(null!=l)return e[r.blotName]=l,(new Delta).insert(e,r.formats(t,n))}else if(r.prototype instanceof BlockBlot&&!deltaEndsWith(e,"\n")&&e.insert("\n"),"blotName"in r&&"formats"in r&&"function"==typeof r.formats)return applyFormat(e,r.blotName,r.formats(t,n),n);return e}function matchBreak(t,e){return deltaEndsWith(e,"\n")||e.insert("\n"),e}function matchCodeBlock(t,e,n){const r=n.query("code-block");return applyFormat(e,"code-block",!r||!("formats"in r)||"function"!=typeof r.formats||r.formats(t,n),n)}function matchIgnore(){return new Delta}function matchIndent(t,e,n){const r=n.query(t);if(null==r||"list"!==r.blotName||!deltaEndsWith(e,"\n"))return e;let l=-1,i=t.parentNode;for(;null!=i;)["OL","UL"].includes(i.tagName)&&(l+=1),i=i.parentNode;return l<=0?e:e.reduce(((t,e)=>e.insert?e.attributes&&"number"==typeof e.attributes.indent?t.push(e):t.insert(e.insert,{indent:l,...e.attributes||{}}):t),new Delta)}function matchList(t,e,n){const r=t;let l="OL"===r.tagName?"ordered":"bullet";const i=r.getAttribute("data-checked");return i&&(l="true"===i?"checked":"unchecked"),applyFormat(e,"list",l,n)}function matchNewline(t,e,n){if(!deltaEndsWith(e,"\n")){if(isLine(t,n)&&(t.childNodes.length>0||t instanceof HTMLParagraphElement))return e.insert("\n");if(e.length()>0&&t.nextSibling){let r=t.nextSibling;for(;null!=r;){if(isLine(r,n))return e.insert("\n");const t=n.query(r);if(t&&t.prototype instanceof BlockEmbed)return e.insert("\n");r=r.firstChild}}}return e}function matchStyles(t,e,n){const r={},l=t.style||{};return"italic"===l.fontStyle&&(r.italic=!0),"underline"===l.textDecoration&&(r.underline=!0),"line-through"===l.textDecoration&&(r.strike=!0),(l.fontWeight?.startsWith("bold")||parseInt(l.fontWeight,10)>=700)&&(r.bold=!0),e=Object.entries(r).reduce(((t,e)=>{let[r,l]=e;return applyFormat(t,r,l,n)}),e),parseFloat(l.textIndent||0)>0?(new Delta).insert("\t").concat(e):e}function matchTable(t,e,n){const r="TABLE"===t.parentElement?.tagName?t.parentElement:t.parentElement?.parentElement;if(null!=r){return applyFormat(e,"table",Array.from(r.querySelectorAll("tr")).indexOf(t)+1,n)}return e}function matchText(t,e,n){let r=t.data;if("O:P"===t.parentElement?.tagName)return e.insert(r.trim());if(!isPre(t)){if(0===r.trim().length&&r.includes("\n")&&!isBetweenInlineElements(t,n))return e;r=r.replace(/[^\S\u00a0]/g," "),r=r.replace(/ {2,}/g," "),(null==t.previousSibling&&null!=t.parentElement&&isLine(t.parentElement,n)||t.previousSibling instanceof Element&&isLine(t.previousSibling,n))&&(r=r.replace(/^ /,"")),(null==t.nextSibling&&null!=t.parentElement&&isLine(t.parentElement,n)||t.nextSibling instanceof Element&&isLine(t.nextSibling,n))&&(r=r.replace(/ $/,"")),r=r.replaceAll("Â "," ")}return e.insert(r)}export{Clipboard as default,matchAttributor,matchBlot,matchNewline,matchText,traverse};
//# sourceMappingURL=/sm/6a11faabc5f8e1300298402725a9c16489dea474f31a1eab804c2631005ba016.map