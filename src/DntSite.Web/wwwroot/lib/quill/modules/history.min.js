/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/quill@2.0.3/modules/history.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Scope}from"parchment";import Module from"../core/module.js";import Quill from"../core/quill.js";class History extends Module{static DEFAULTS={delay:1e3,maxStack:100,userOnly:!1};lastRecorded=0;ignoreChange=!1;stack={undo:[],redo:[]};currentRange=null;constructor(t,e){super(t,e),this.quill.on(Quill.events.EDITOR_CHANGE,((t,e,n,s)=>{t===Quill.events.SELECTION_CHANGE?e&&s!==Quill.sources.SILENT&&(this.currentRange=e):t===Quill.events.TEXT_CHANGE&&(this.ignoreChange||(this.options.userOnly&&s!==Quill.sources.USER?this.transform(e):this.record(e,n)),this.currentRange=transformRange(this.currentRange,e))})),this.quill.keyboard.addBinding({key:"z",shortKey:!0},this.undo.bind(this)),this.quill.keyboard.addBinding({key:["z","Z"],shortKey:!0,shiftKey:!0},this.redo.bind(this)),/Win/i.test(navigator.platform)&&this.quill.keyboard.addBinding({key:"y",shortKey:!0},this.redo.bind(this)),this.quill.root.addEventListener("beforeinput",(t=>{"historyUndo"===t.inputType?(this.undo(),t.preventDefault()):"historyRedo"===t.inputType&&(this.redo(),t.preventDefault())}))}change(t,e){if(0===this.stack[t].length)return;const n=this.stack[t].pop();if(!n)return;const s=this.quill.getContents(),i=n.delta.invert(s);this.stack[e].push({delta:i,range:transformRange(n.range,i)}),this.lastRecorded=0,this.ignoreChange=!0,this.quill.updateContents(n.delta,Quill.sources.USER),this.ignoreChange=!1,this.restoreSelection(n)}clear(){this.stack={undo:[],redo:[]}}cutoff(){this.lastRecorded=0}record(t,e){if(0===t.ops.length)return;this.stack.redo=[];let n=t.invert(e),s=this.currentRange;const i=Date.now();if(this.lastRecorded+this.options.delay>i&&this.stack.undo.length>0){const t=this.stack.undo.pop();t&&(n=n.compose(t.delta),s=t.range)}else this.lastRecorded=i;0!==n.length()&&(this.stack.undo.push({delta:n,range:s}),this.stack.undo.length>this.options.maxStack&&this.stack.undo.shift())}redo(){this.change("redo","undo")}transform(t){transformStack(this.stack.undo,t),transformStack(this.stack.redo,t)}undo(){this.change("undo","redo")}restoreSelection(t){if(t.range)this.quill.setSelection(t.range,Quill.sources.USER);else{const e=getLastChangeIndex(this.quill.scroll,t.delta);this.quill.setSelection(e,Quill.sources.USER)}}}function transformStack(t,e){let n=e;for(let e=t.length-1;e>=0;e-=1){const s=t[e];t[e]={delta:n.transform(s.delta,!0),range:s.range&&transformRange(s.range,n)},n=s.delta.transform(n),0===t[e].delta.length()&&t.splice(e,1)}}function endsWithNewlineChange(t,e){const n=e.ops[e.ops.length-1];return null!=n&&(null!=n.insert?"string"==typeof n.insert&&n.insert.endsWith("\n"):null!=n.attributes&&Object.keys(n.attributes).some((e=>null!=t.query(e,Scope.BLOCK))))}function getLastChangeIndex(t,e){const n=e.reduce(((t,e)=>t+(e.delete||0)),0);let s=e.length()-n;return endsWithNewlineChange(t,e)&&(s-=1),s}function transformRange(t,e){if(!t)return t;const n=e.transformPosition(t.index);return{index:n,length:e.transformPosition(t.index+t.length)-n}}export{History as default,getLastChangeIndex};
//# sourceMappingURL=/sm/70cfe4afc0138c970640ecf4b62f6b5fa8a15223be6ec33766ad68d75d29f3d4.map