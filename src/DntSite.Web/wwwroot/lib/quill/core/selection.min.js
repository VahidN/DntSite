/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/quill@2.0.3/core/selection.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{LeafBlot,Scope}from"parchment";import{cloneDeep,isEqual}from"lodash-es";import Emitter from"./emitter.js";import logger from"./logger.js";const debug=logger("quill:selection");export class Range{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.index=t,this.length=e}}class Selection{constructor(t,e){this.emitter=e,this.scroll=t,this.composing=!1,this.mouseDown=!1,this.root=this.scroll.domNode,this.cursor=this.scroll.create("cursor",this),this.savedRange=new Range(0,0),this.lastRange=this.savedRange,this.lastNative=null,this.handleComposition(),this.handleDragging(),this.emitter.listenDOM("selectionchange",document,(()=>{this.mouseDown||this.composing||setTimeout(this.update.bind(this,Emitter.sources.USER),1)})),this.emitter.on(Emitter.events.SCROLL_BEFORE_UPDATE,(()=>{if(!this.hasFocus())return;const t=this.getNativeRange();null!=t&&t.start.node!==this.cursor.textNode&&this.emitter.once(Emitter.events.SCROLL_UPDATE,((e,s)=>{try{this.root.contains(t.start.node)&&this.root.contains(t.end.node)&&this.setNativeRange(t.start.node,t.start.offset,t.end.node,t.end.offset);const n=s.some((t=>"characterData"===t.type||"childList"===t.type||"attributes"===t.type&&t.target===this.root));this.update(n?Emitter.sources.SILENT:e)}catch(t){}}))})),this.emitter.on(Emitter.events.SCROLL_OPTIMIZE,((t,e)=>{if(e.range){const{startNode:t,startOffset:s,endNode:n,endOffset:o}=e.range;this.setNativeRange(t,s,n,o),this.update(Emitter.sources.SILENT)}})),this.update(Emitter.sources.SILENT)}handleComposition(){this.emitter.on(Emitter.events.COMPOSITION_BEFORE_START,(()=>{this.composing=!0})),this.emitter.on(Emitter.events.COMPOSITION_END,(()=>{if(this.composing=!1,this.cursor.parent){const t=this.cursor.restore();if(!t)return;setTimeout((()=>{this.setNativeRange(t.startNode,t.startOffset,t.endNode,t.endOffset)}),1)}}))}handleDragging(){this.emitter.listenDOM("mousedown",document.body,(()=>{this.mouseDown=!0})),this.emitter.listenDOM("mouseup",document.body,(()=>{this.mouseDown=!1,this.update(Emitter.sources.USER)}))}focus(){this.hasFocus()||(this.root.focus({preventScroll:!0}),this.setRange(this.savedRange))}format(t,e){this.scroll.update();const s=this.getNativeRange();if(null!=s&&s.native.collapsed&&!this.scroll.query(t,Scope.BLOCK)){if(s.start.node!==this.cursor.textNode){const t=this.scroll.find(s.start.node,!1);if(null==t)return;if(t instanceof LeafBlot){const e=t.split(s.start.offset);t.parent.insertBefore(this.cursor,e)}else t.insertBefore(this.cursor,s.start.node);this.cursor.attach()}this.cursor.format(t,e),this.scroll.optimize(),this.setNativeRange(this.cursor.textNode,this.cursor.textNode.data.length),this.update()}}getBounds(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const s=this.scroll.length();let n;t=Math.min(t,s-1),e=Math.min(t+e,s-1)-t;let[o,i]=this.scroll.leaf(t);if(null==o)return null;if(e>0&&i===o.length()){const[e]=this.scroll.leaf(t+1);if(e){const[s]=this.scroll.line(t),[n]=this.scroll.line(t+1);s===n&&(o=e,i=0)}}[n,i]=o.position(i,!0);const r=document.createRange();if(e>0)return r.setStart(n,i),[o,i]=this.scroll.leaf(t+e),null==o?null:([n,i]=o.position(i,!0),r.setEnd(n,i),r.getBoundingClientRect());let l,a="left";if(n instanceof Text){if(!n.data.length)return null;i<n.data.length?(r.setStart(n,i),r.setEnd(n,i+1)):(r.setStart(n,i-1),r.setEnd(n,i),a="right"),l=r.getBoundingClientRect()}else{if(!(o.domNode instanceof Element))return null;l=o.domNode.getBoundingClientRect(),i>0&&(a="right")}return{bottom:l.top+l.height,height:l.height,left:l[a],right:l[a],top:l.top,width:0}}getNativeRange(){const t=document.getSelection();if(null==t||t.rangeCount<=0)return null;const e=t.getRangeAt(0);if(null==e)return null;const s=this.normalizeNative(e);return debug.info("getNativeRange",s),s}getRange(){const t=this.scroll.domNode;if("isConnected"in t&&!t.isConnected)return[null,null];const e=this.getNativeRange();if(null==e)return[null,null];return[this.normalizedToRange(e),e]}hasFocus(){return document.activeElement===this.root||null!=document.activeElement&&contains(this.root,document.activeElement)}normalizedToRange(t){const e=[[t.start.node,t.start.offset]];t.native.collapsed||e.push([t.end.node,t.end.offset]);const s=e.map((t=>{const[e,s]=t,n=this.scroll.find(e,!0),o=n.offset(this.scroll);return 0===s?o:n instanceof LeafBlot?o+n.index(e,s):o+n.length()})),n=Math.min(Math.max(...s),this.scroll.length()-1),o=Math.min(n,...s);return new Range(o,n-o)}normalizeNative(t){if(!contains(this.root,t.startContainer)||!t.collapsed&&!contains(this.root,t.endContainer))return null;const e={start:{node:t.startContainer,offset:t.startOffset},end:{node:t.endContainer,offset:t.endOffset},native:t};return[e.start,e.end].forEach((t=>{let{node:e,offset:s}=t;for(;!(e instanceof Text)&&e.childNodes.length>0;)if(e.childNodes.length>s)e=e.childNodes[s],s=0;else{if(e.childNodes.length!==s)break;e=e.lastChild,s=e instanceof Text?e.data.length:e.childNodes.length>0?e.childNodes.length:e.childNodes.length+1}t.node=e,t.offset=s})),e}rangeToNative(t){const e=this.scroll.length(),s=(t,s)=>{t=Math.min(e-1,t);const[n,o]=this.scroll.leaf(t);return n?n.position(o,s):[null,-1]};return[...s(t.index,!1),...s(t.index+t.length,!0)]}setNativeRange(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(debug.info("setNativeRange",t,e,s,n),null!=t&&(null==this.root.parentNode||null==t.parentNode||null==s.parentNode))return;const i=document.getSelection();if(null!=i)if(null!=t){this.hasFocus()||this.root.focus({preventScroll:!0});const{native:r}=this.getNativeRange()||{};if(null==r||o||t!==r.startContainer||e!==r.startOffset||s!==r.endContainer||n!==r.endOffset){t instanceof Element&&"BR"===t.tagName&&(e=Array.from(t.parentNode.childNodes).indexOf(t),t=t.parentNode),s instanceof Element&&"BR"===s.tagName&&(n=Array.from(s.parentNode.childNodes).indexOf(s),s=s.parentNode);const o=document.createRange();o.setStart(t,e),o.setEnd(s,n),i.removeAllRanges(),i.addRange(o)}}else i.removeAllRanges(),this.root.blur()}setRange(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Emitter.sources.API;if("string"==typeof e&&(s=e,e=!1),debug.info("setRange",t),null!=t){const s=this.rangeToNative(t);this.setNativeRange(...s,e)}else this.setNativeRange(null);this.update(s)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Emitter.sources.USER;const e=this.lastRange,[s,n]=this.getRange();if(this.lastRange=s,this.lastNative=n,null!=this.lastRange&&(this.savedRange=this.lastRange),!isEqual(e,this.lastRange)){if(!this.composing&&null!=n&&n.native.collapsed&&n.start.node!==this.cursor.textNode){const t=this.cursor.restore();t&&this.setNativeRange(t.startNode,t.startOffset,t.endNode,t.endOffset)}const s=[Emitter.events.SELECTION_CHANGE,cloneDeep(this.lastRange),cloneDeep(e),t];this.emitter.emit(Emitter.events.EDITOR_CHANGE,...s),t!==Emitter.sources.SILENT&&this.emitter.emit(...s)}}}function contains(t,e){try{e.parentNode}catch(t){return!1}return t.contains(e)}export default Selection;
//# sourceMappingURL=/sm/5e9ca8966071975f1351750fa5872b8351632982cc0e33c9271d403f310b9b60.map